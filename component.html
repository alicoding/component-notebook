<style>
  @font-face {
    font-family: 'FontAwesome';
    src: url('vendor/fonts/fontawesome-webfont.eot?v=4.0.3');
    src: url('vendor/fonts/fontawesome-webfont.eot?#iefix&v=4.0.3') format('embedded-opentype'), url('vendor/fonts/fontawesome-webfont.woff?v=4.0.3') format('woff'), url('vendor/fonts/fontawesome-webfont.ttf?v=4.0.3') format('truetype'), url('vendor/fonts/fontawesome-webfont.svg?v=4.0.3#fontawesomeregular') format('svg');
    font-weight: normal;
    font-style: normal;
  }
</style>
<script src="vendor/markdown/markdown.min.js"></script>

<polymer-element name="ceci-notebook" extends="ceci-element"
                 attributes="backgroundcolor textcolor name" 
                 backgroundcolor="#000000" 
                 textcolor="#ffffff" 
                 name="my notes">
  <template>
    <link href="font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="component.css">
    <div id="header" class="header">
      <div class="name">note {{currentPage}} of {{pageCount}}</div>
      <div class="prev headerbutton" on-click="{{prevPage}}"><i class="fa fa-angle-left"></i></div>
      <div class="next headerbutton" on-click="{{nextPage}}"><i class="fa fa-angle-right"></i></div>
      <div class="trash headerbutton" on-click="{{deletePage}}"><i class="fa fa-trash-o"></i></div>
      <div class="add headerbutton" on-click="{{newPage}}"><i class="fa fa-plus"></i></div>
      <div class="text headerbutton" on-click="{{wantsText}}"><i class="fa fa-header"></i></div>
      <div class="camera headerbutton" on-click="{{wantsImage}}"><i class="fa fa-camera"></i></div>
    </div>
    <div id="page" class="page"><ul id="list"></ul></div>
    <shadow></shadow>
  </template>
  <ceci-definition>
    {
      "tags": ["data", "words"],
      "thumbnail": "./thumbnail.png",
      "name": "notebook",
      "description": "Stores pages of stuff",
      "broadcasts": {
        "wantsPicture": {
          "label": "User wants picture",
          "description": "The user clicked on the picture icon"
        },
        "wantsText": {
          "label": "User wants text",
          "description": "The user clicked on the plus icon"
        }
      },
      "listeners": {
        "newPage": {
          "description": "Create a new page",
          "label": "New Page",
          "default" : false
        },
        "nextPage": {
          "description": "Go to next page",
          "label": "Next Page",
          "default" : false
        },
        "prevPage": {
          "description": "Go to previous",
          "label": "Previous Page",
          "default" : false
        },
        "deletePage": {
          "description": "Delete current page",
          "label": "Delete Page",
          "default" : false
        },
        "addImage": {
          "description": "Add image to current page",
          "label": "Add image",
          "default": false
        },
        "addText": {
          "description": "Add markdown text to current page",
          "label": "Add text",
          "default": false
        },
        "addHTML": {
          "description": "Add an HTML fragment to current page",
          "label": "Add HTML",
          "default": false
        }
      },
      "attributes": {
        "backgroundcolor": {
          "label": "Background Color",
          "editable": "color"
        },
        "textcolor": {
          "label": "Text Color",
          "editable": "color"
        },
        "name": {
          "label": "Notebook Name",
          "editable": "text"
        }
      }
    }
  </ceci-definition>
  <script>
    Polymer('ceci-notebook', {
      currentPage: 1,
      pageCount:4,
      ready: function() {
        this.super();
        if (localStorage['hack-collection-pages'] == undefined) {
          localStorage['hack-collection-pages'] = JSON.stringify(
            {
            1:['text', 'some other text'],
            2:['page 2', 'some other text'],
            3:['page 3', 'some other text'],
            4:['page 4', 'some other text'],
            'pageCount': 4,
            'currentPage': 1
          });
        }
        var data = this.getData();
        this.currentPage = data['currentPage'] || 1;
        this.pageCount = data['pageCount'] || 1;
        this.updateDisplay();
      },
      updateDisplay: function() {
        this.$.list.innerHTML = "";
        var item;
        var pageData = this.getData()[this.currentPage];
        console.log("pageData.length", pageData.length);
        for (var i=0; i<pageData.length; i++) {
          this.addTextToDisplay(pageData[i]);
        }
      },
      addTextToDisplay: function(stuff) {
        list = this.$.list;
        var item = document.createElement("li");
        item.innerHTML = stuff
        list.appendChild(item);
      },
      addImage: function(imgsrc) {
        var snippet = "<img src='" + imgsrc + "'></img>"
        this.addHTML(snippet);
      },
      addText: function(stuff) {
        this.addHTML(markdown.toHTML(stuff));
      },
      addHTML: function(snippet) {
        this.addTextToDisplay(snippet);
        var data = this.getData();
        data[this.currentPage].push(snippet);
        localStorage['hack-collection-pages'] = JSON.stringify(data);
      },
      newPage: function() {
        this.pageCount += 1;
        var data = this.getData();
        data['pageCount'] = this.pageCount;
        data[this.pageCount] = [];
        localStorage['hack-collection-pages'] = JSON.stringify(data);
      },
      nextPage: function() {
        this.currentPage = Math.min(this.currentPage+1, this.getData()['pageCount']);
        var data = this.getData();
        data['currentPage'] = this.currentPage;
        localStorage['hack-collection-pages'] = JSON.stringify(data);
        this.updateDisplay();
      },
      prevPage: function() {
        this.currentPage = Math.max(this.currentPage-1, 1);
        var data = this.getData();
        data['currentPage'] = this.currentPage;
        localStorage['hack-collection-pages'] = JSON.stringify(data);
        this.updateDisplay();
      },
      deletePage: function() {
        this.currentPage = Math.max(this.currentPage-1, 1);
        var data = this.getData();
        delete data[this.currentPage];
        this.pageCount--;
        console.log("this.currentPage", this.currentPage);
        console.log("this.pageCount", this.pageCount);
        if (this.pageCount == 0) {
          this.newPage();
        }
        if (this.currentPage > this.pageCount) {
          this.currentPage = this.pageCount;
        }
        console.log("this.currentPage", this.currentPage);
        console.log("this.pageCount", this.pageCount);
        localStorage['hack-collection-pages'] = JSON.stringify(data);
        this.updateDisplay();
      },
      wantsPicture: function() {
        this.broadcast("getpicture", "wantpicture");
      },
      wantsText: function() {
        this.broadcast("gettext", "wanttext");
      },
      attached : function(){
        this.super();
      },
      getData: function() {
        return JSON.parse(localStorage['hack-collection-pages']);
      },
      backgroundcolorChanged: function (oldValue, newValue) {
        this.style.backgroundColor = newValue;
      },
      textcolorChanged: function (oldValue, newValue) {
        this.style.color = newValue;
      }
    });
  </script>
</polymer-element>
